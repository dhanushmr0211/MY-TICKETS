<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking Successful</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-light d-flex justify-content-center align-items-center vh-100">

  <div class="card shadow-lg text-center p-5" style="max-width: 500px; border-radius: 20px;">
    <div class="mb-4">
      <img id="event-image" src="" width="120" style="border-radius: 10px;">
    </div>
    <h2 class="text-success">Booking Confirmed üéâ</h2>
    <p class="text-muted">Thank you for booking your ticket.</p>

    <hr>

    <p><strong>Payment ID:</strong> <span id="payment-id"></span></p>
    <p><strong>Event:</strong> <span id="event-title"></span></p>
    <p><strong>Total Paid:</strong> ‚Çπ<span id="amount"></span></p>

    <button id="downloadTicket" class="btn btn-primary mt-3">üéüÔ∏è Download Ticket</button>
  </div>

<script>
// Get booking details from URL
const urlParams = new URLSearchParams(window.location.search);
const paymentId = urlParams.get("payment_id");
const title = urlParams.get("title") || "Event";
const amount = urlParams.get("amount") || "500";
const image = urlParams.get("image") || "default.jpg";

// Show on confirmation page
document.getElementById("payment-id").textContent = paymentId;
document.getElementById("event-title").textContent = title;
document.getElementById("amount").textContent = amount;
document.getElementById("event-image").src = image;

// Convert image to Base64 for jsPDF
function getBase64Image(url) {
  return new Promise((resolve, reject) => {
    let img = new Image();
    img.crossOrigin = "anonymous";
    img.src = url;
    img.onload = function () {
      let canvas = document.createElement("canvas");
      canvas.width = img.width;
      canvas.height = img.height;
      let ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0);
      resolve(canvas.toDataURL("image/jpeg"));
    };
    img.onerror = reject;
  });
}

document.getElementById("downloadTicket").onclick = async function () {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("landscape");

  // Blue background
  doc.setFillColor(13, 110, 253);
  doc.rect(10, 10, 270, 120, 'F');

  // White ticket area
  doc.setFillColor(255,255,255);
  doc.roundedRect(20, 20, 250, 100, 8, 8, 'F');

  // Event image (left)
  try {
    let eventImgBase64 = await getBase64Image(image);
    doc.addImage(eventImgBase64, "JPEG", 28, 32, 50, 50);
  } catch {
    // If image fails, skip
  }

  // Title
  doc.setFontSize(24);
  doc.setTextColor(13, 110, 253);
  doc.setFont("helvetica", "bold");
  doc.text(title, 145, 40, { align: "center" });

  // Event details
  doc.setFontSize(14);
  doc.setTextColor(33, 37, 41);
  doc.setFont("helvetica", "normal");
  doc.text(`Payment ID:`, 90, 60);
  doc.text(paymentId, 140, 60);
  doc.text(`Amount Paid:`, 90, 75);
  doc.text(`‚Çπ${amount}`, 140, 75);
  doc.text("Status:", 90, 90);
  doc.setTextColor(40, 167, 69);
  doc.text("Confirmed ‚úÖ", 140, 90);

  // QR Code (right)
  try {
    let qrCanvas = document.createElement("canvas");
    new QRCode(qrCanvas, {
      text: `PaymentID:${paymentId}, Event:${title}, Amount:${amount}`,
      width: 100,
      height: 100,
      colorDark: "#0d6efd",
      colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });
    await new Promise(r => setTimeout(r, 500)); // wait for QR to render
    let qrDataUrl = qrCanvas.querySelector("img")?.src || qrCanvas.toDataURL("image/png");
    doc.addImage(qrDataUrl, "PNG", 212, 42, 46, 46);
  } catch {
    doc.setFontSize(10);
    doc.setTextColor(220, 53, 69);
    doc.text("QR code unavailable", 235, 65, { align: "center" });
  }

  // Footer
  doc.setFontSize(12);
  doc.setTextColor(108, 117, 125);
  doc.text("Thank you for booking with MY TICKETS!", 145, 115, { align: "center" });

  // Save PDF
  doc.save(`${title.replace(/\s+/g, "_")}_Ticket.pdf`);
};
</script>

</body>
</html>
